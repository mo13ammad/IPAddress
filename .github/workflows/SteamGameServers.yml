# Workflow Name
name: Sync Steam Game Servers

# Triggers: When should this workflow run?
on:
  # Allows manual execution from the GitHub Actions tab
  workflow_dispatch:

  # Scheduled run: Every hour, at the beginning of the hour
  schedule:
    - cron: '0 * * * *'

jobs:
  sync-games:
    # Prevent this workflow from running concurrently with itself.
    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false
      
    # Use the latest version of Ubuntu for this job
    runs-on: ubuntu-latest
    # Increase the timeout because fetching all apps can be time-consuming
    timeout-minutes: 180

    # Grant write permissions to the GITHUB_TOKEN for this job
    permissions:
      contents: write

    # Job steps
    steps:
      # Step 1: Checkout your repository's code
      - name: Checkout local repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Sync and Commit Steam Game Servers
      - name: Sync and Commit Steam Game Servers
        run: |
          # Install jq, a command-line JSON processor
          sudo apt-get update && sudo apt-get install -y jq

          # Configure Git for committing with your details
          git config --global user.name "mo13ammad"
          git config --global user.email "mo13ammad@users.noreply.github.com"

          echo "Creating game server directory..."
          mkdir -p game-servers/steam

          echo "Fetching the complete list of Steam apps..."
          curl -s "https://api.steampowered.com/ISteamApps/GetAppList/v2/" -o applist.json

          if [ ! -s applist.json ]; then
            echo "Error: Failed to fetch Steam app list."
            exit 1
          fi

          COMMITS_MADE=0
          echo "Processing all apps and committing changes individually..."
          jq -c '.applist.apps[]' applist.json | while read -r app; do
            APP_ID=$(echo "$app" | jq -r '.appid')
            GAME_NAME=$(echo "$app" | jq -r '.name')

            if [ -z "$GAME_NAME" ] || [ ${#GAME_NAME} -lt 2 ]; then
              continue
            fi
            
            FILENAME=$(echo "$GAME_NAME" | tr -c '[:alnum:]_.-' '_')
            FILEPATH="game-servers/steam/${FILENAME}.cidr"
            
            API_URL="https://api.steampowered.com/ISteamApps/GetSDRConfig/v1?appid=${APP_ID}"
            IP_LIST=$(curl -s "$API_URL" | jq -r '.pops[].relays[]? | .ipv4, .ipv6 | select(. != null)')

            if [ -n "$IP_LIST" ]; then
              # Write new content to a temporary file
              TMP_FILE=$(mktemp)
              echo "$IP_LIST" > "$TMP_FILE"

              # Only commit if the file is new or if its content has changed
              if [ ! -f "$FILEPATH" ] || ! diff -q "$TMP_FILE" "$FILEPATH" >/dev/null; then
                echo "Changes found for: $GAME_NAME. Saving and committing..."
                mv "$TMP_FILE" "$FILEPATH"
                
                git add "$FILEPATH"
                COMMIT_DATE=$(TZ="Asia/Tehran" date +'%Y-%m-%d %H:%M:%S')
                git commit -m "Auto-sync: Update IPs for $GAME_NAME on $COMMIT_DATE"
                COMMITS_MADE=$((COMMITS_MADE + 1))
              else
                # No changes, just remove the temp file
                rm "$TMP_FILE"
              fi
            fi
          done

          # Clean up the temporary applist file
          rm applist.json

          # Push all the new commits at the end of the process
          if [ "$COMMITS_MADE" -gt 0 ]; then
            echo "Pushing $COMMITS_MADE new commit(s)..."
            git push
          else
            echo "No new commits were made. Nothing to push."
          fi
          
          echo "Finished syncing all discoverable Steam game servers."
